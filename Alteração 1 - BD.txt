-- O tipo de documento está com o enum "Requirimento", segue alteração para correto
use sistema_de_protocolo;

ALTER TABLE `sistema_de_protocolo`.`documento` 
CHANGE COLUMN `tipo` `tipo` ENUM('Requerimento', 'Pedido de Compra', 'Ata', 'Relatório') NOT NULL ;

alter table usuario modify column nivel enum("Comum", "Gerente", "Desativado") not null;


delimiter //
	create trigger transfere_documentos_para_gestor after update on usuario for each row 
    begin
		if(new.setor = "Desativado" and new.nivel = "Desativado") then
        
			if(select count(*) from documento where cpf_possuidor = new.cpf or cpf_destinatario = new.cpf) > 0 then
				update documento set cpf_destinatario = (select cpf from usuario where nivel = "Gerente" limit 1),
				estado = "Pendente" where cpf_possuidor = new.cpf or cpf_destinatario = new.cpf;
            end if ;
		end if;
    end ;
// delimiter ;

--View para visualização de documento
USE `sistema_de_protocolo`;
CREATE  OR REPLACE VIEW view_documentos_detalhados AS
SELECT 
    d.nProtocolo,
    d.cpf_possuidor,
    p.nome AS nome_possuidor,
    d.cpf_destinatario,
    u.nome AS nome_destinatario,
    u.setor AS setor_destinatario,
    d.data_de_cadastro,
    d.tipo,
    d.titulo,
    d.estado
FROM 
    documento d
INNER JOIN 
    usuario p ON d.cpf_possuidor = p.cpf
INNER JOIN
    usuario u ON d.cpf_destinatario = u.cpf;


--View para historico de documento
USE `sistema_de_protocolo`;
CREATE  OR REPLACE VIEW `view_movimentacao_detalhada` AS
SELECT
	m.ID,
    m.nProtocolo,
    t.titulo AS titulo,
    m.estado,
    m.cpf_destinatario,
    d.nome AS nome_destinatario,
    m.data_da_acao,
    m.cpf_remetente,
    r.nome AS nome_remetente
FROM movimentacao m
INNER JOIN 
	usuario d ON m.cpf_destinatario = d.cpf
INNER JOIN 
	usuario r ON m.cpf_remetente = r.cpf
INNER JOIN
	documento t ON m.nProtocolo = t.nProtocolo;
    

